Option Explicit

Private mLoginSucceeded As Boolean

Private Sub CommandButton_cansel_Click()
    mLoginSucceeded = False
    Me.Hide
End Sub

Private Sub CommandButton1_ok_Click()
    Static inProgress As Boolean
    If inProgress Then Exit Sub

    inProgress = True
    Call Login
    inProgress = False
End Sub

Private Sub UserForm_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Select Case KeyCode
        Case vbKeyReturn
            KeyCode = 0
            CommandButton1_ok.value = True       ' ← cmdOK → 実際の名前へ
        Case vbKeyEscape
            KeyCode = 0
            CommandButton_cansel.value = True    ' ← cmdCancel → 実際の名前へ
    End Select
End Sub

Public Function RequestLogin() As Boolean
    mLoginSucceeded = False
    Me.Show vbModal
    RequestLogin = mLoginSucceeded
End Function

Public Sub Login()
    On Error GoTo Failed

    Dim client As IQuavisClient
    Set client = CreateClient("http://rdgpm0701/iquavis-api", True)
    Debug.Print "[Login] BaseUrl=" & client.BaseUrl

    AuthenticateClient client, Me.TextBox_ID, Me.TextBox1_Pass
    Debug.Print "[Login] token length=" & Len(client.AccessToken)

    modSessionManager.SetAuthenticatedClient client
    mLoginSucceeded = True
    Me.Hide
    Exit Sub

Failed:
    MsgBox "ログインに失敗しました: " & Err.Description, vbCritical
End Sub

